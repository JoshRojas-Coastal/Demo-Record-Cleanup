<template>
	<lightning-card>
		<template if:true={spinnerVisible}>
			<lightning-spinner variant="brand" size="medium" title="Working ..." alternative-text="Working ...">
			</lightning-spinner>
		</template>

		<header slot="title" class="slds-media slds-media_center">
			<div class="slds-media__figure slds-icon_container">
				<svg class="slds-icon slds-icon_small" xmlns="http://www.w3.org/2000/svg">
					<use xlink:href={iconUrl}></use>
				</svg>
			</div>
			<div class="slds-media__body">
				<h2><strong>{cardTitle}</strong></h2>
			</div>
		</header>

		<div slot="actions">
			<lightning-button-icon-stateful
				variant="neutral"
				label="Help"
				icon-name="utility:question"
				selected={helpSectionVisible}
				onclick={handleHelpButton}
			>
			</lightning-button-icon-stateful>
		</div>

		<template if:false={deletionInProgress}>
			<header class="slds-p-horizontal_large slds-hyphenate">
				Delete any spurious or temporary records that were created during a demo or during testing, leaving the org in a
				clean state for the next demo.
			</header>
			<template if:false={cleanupTasksEmpty}>
				<template if:true={tooManyCleanupTasks}>
					<p class="slds-var-p-around_large">
						<em>
							You have&nbsp;
							<lightning-formatted-number value={totalCleanupTasks}> </lightning-formatted-number> &nbsp;tasks to run
							and the maximum is&nbsp;
							<lightning-formatted-number value={maximumCleanupTasks}> </lightning-formatted-number>
							. Either deselect some of the tasks or deactivate some from the&nbsp;
							<lightning-formatted-url value={cleanupTaskListViewURL} label="Demo Cleanup Tasks page">
							</lightning-formatted-url>
							.
						</em>
					</p>
				</template>
				<template if:false={tooManyCleanupTasks}>
					<section class="slds-var-p-top_medium slds-var-p-horizontal_large">
						<lightning-datatable
							data={cleanupTasks}
							columns={cleanupTasksColumns}
							key-field="itemId"
							onrowselection={handleRowSelection}
						>
						</lightning-datatable>
					</section>
					<section class="slds-p-horizontal_large slds-p-vertical_medium">
						<lightning-layout multiple-rows="false" horizontal-align="spread" vertical-align="center">
							<lightning-layout-item size="6">
								<strong>
									Total Records: &nbsp;
									<lightning-formatted-number value={totalRecords}> </lightning-formatted-number>
								</strong>
							</lightning-layout-item>
							<lightning-layout-item size="6">
								<lightning-button
									class="slds-float_right"
									variant="destructive"
									disabled={cleanupButtonDisabled}
									label="Clean Up the Demo"
									icon-name="utility:delete"
									onclick={showModal}
								>
								</lightning-button>
							</lightning-layout-item>
						</lightning-layout>
					</section>
				</template>
			</template>
			<template if:true={cleanupTasksEmpty}>
				<p class="slds-var-p-around_large">
					<em>
						You do not have any active reset task items. Create new records from the&nbsp;
						<lightning-formatted-url value={cleanupTaskListViewURL} label="Demo Cleanup Tasks page">
						</lightning-formatted-url>
						&nbsp;or activate existing ones.
					</em>
				</p>
			</template>
		</template>

		<template if:true={deletionInProgress}>
			<section class="slds-p-horizontal_large">
				<template if:false={deletionFinished}>
					<p class="slds-var-p-bottom_medium slds-hyphenate">
						If you navigate away from this page or tab, the record deletions will continue, but you will not be able to
						monitor the progress.
					</p>
				</template>
				<template if:true={deletionFinished}>
					<p class="slds-var-p-bottom_medium slds-hyphenate">
						Demo cleanup has completed.
					</p>
				</template>
				<div class="slds-var-p-vertical_medium slds-var-p-horizontal_x-large">
					<table class="slds-text-body_small">
						<tbody>
							<template for:each={selectedRows} for:item="ct">
								<tr class="slds-p-around_none" key={ct.itemId}>
									<td class="runningObject">
										<strong>
											<lightning-formatted-text value={ct.itemLabelPlural} class="slds-truncate">
											</lightning-formatted-text>
										</strong>
									</td>
									<td class="runningCounts">
										<lightning-formatted-number value={ct.itemRunningTotal}> </lightning-formatted-number>
										&nbsp;/&nbsp;
										<lightning-formatted-number value={ct.itemCount}> </lightning-formatted-number>
										&nbsp;&nbsp;(
										<lightning-formatted-number value={ct.itemPercentage}> </lightning-formatted-number>
										%)
									</td>
									<td class="runningRemaining">
										<template if:true={ct.itemDeletionFinished}>
											<template if:true={ct.itemNumberOfErrors}>
												<strong><span class="slds-text-color_error">Done</span></strong>
											</template>
											<template if:false={ct.itemNumberOfErrors}>
												<strong><span class="slds-text-color_success">Done</span></strong>
											</template>
										</template>
										<template if:false={ct.itemDeletionFinished}>
											<lightning-formatted-number value={ct.itemRemaining} class="slds-text-align_right">
											</lightning-formatted-number>
										</template>
									</td>
									<td class="runningErrors">
										<template if:true={ct.itemNumberOfErrors}>
											<span class="slds-text-color_error">
												<lightning-formatted-number value={ct.itemNumberOfErrors}>
												</lightning-formatted-number>
												&nbsp;error(s)
											</span>
										</template>
									</td>
								</tr>
								<tr key={ct.itemAPIName}>
									<td class="runningProgressBar" colspan="4">
										<div class="slds-var-p-bottom_medium">
											<lightning-progress-bar
												size="large"
												value={ct.itemPercentage}
												aria-valuemin="0"
												aria-valuemax={ct.itemCount}
												aria-valuenow={ct.itemRunningTotal}
												role="progressbar"
											>
											</lightning-progress-bar>
										</div>
									</td>
								</tr>
							</template>
						</tbody>
					</table>
				</div>
				<template if:true={deletionHadErrors}>
					<p class="slds-var-p-bottom_small slds-text-color_error slds-hyphenate">
						The following errors occurred during the cleanup. Usually this means that the you deleted a parent record
						and its child while also attempting to delete the same child record in another Demo Cleanup Task. You should
						find that all the records were, in fact, deleted.
					</p>
					<p class="slds-var-p-bottom_medium slds-text-color_error slds-hyphenate">
						To make sure this does not occur again, please check your Demo Cleanup Tasks for any lookup possibilities
						(<em>e.g.</em>, master-detail relationships) that could cause a child record to be deleted along with its
						parent. Either deselect or de-activate the Demo Cleanup Task that contains the redundant child deletions.
					</p>
					<div class="slds-var-p-bottom_medium slds-scrollable scrollerSize">
						<lightning-datatable columns={errorListColumns} data={errorList} key-field="id" hide-checkbox-column="true">
						</lightning-datatable>
					</div>
				</template>
			</section>
		</template>

		<template if:true={helpSectionVisible}>
			<section class="slds-p-horizontal_large">
				<lightning-tile class="slds-tile_board slds-box slds-theme_shade">
					<lightning-icon slot="media" icon-name="utility:info"> </lightning-icon>
					<h2><strong>Motivation</strong></h2>
					<p class="slds-p-top_small slds-hyphenate">
						You know how demos often get cluttered with artifacts from previous demo or test runs? Records are created
						and never get cleaned up, leaving you wondering long afterwards whether or not they are necessary for the
						demo scenarios or if they can be cleared away. This component executes a simple cleanup between demos so
						that any future demo can be started with a clean environment, deleting any records that were created by
						previous demos, dry runs, or tests.
					</p>
					<h2 class="slds-p-top_large"><strong>How It Works</strong></h2>
					<p class="slds-p-top_small slds-hyphenate">
						The component is driven by a series of demo cleanup tasks which you create. Each task contains an object
						identifier and a specification telling the component which records of that object are to be deleted. For
						example, records that have been hand-crafted for a demo scenario or those that have been uploaded in bulk
						for use in Einstein Analytics dashboards might be tagged with custom checkbox fields to indicate that they
						are to be retained. Any other records of that object type not so tagged would then be considered to be a
						by-product of a demo run and could be safely deleted.
					</p>
					<p class="slds-p-top_small slds-hyphenate">
						To set up the demo cleanup tasks, just navigate to the&nbsp;
						<lightning-formatted-url value={cleanupTaskListViewURL} label="Demo Cleanup Tasks page">
						</lightning-formatted-url>
						&nbsp;and create as many tasks as you need (although no more than 90 can be selected at any given time).
						Each one will require a description, which will appear in the task list, the API name of the object whose
						records you want to delete, and a&nbsp;
						<lightning-formatted-url
							label="SOQL WHERE clause expression"
							value="https://developer.salesforce.com/docs/atlas.en-us.soql_sosl.meta/soql_sosl/sforce_api_calls_soql_select_conditionexpression.htm"
						>
						</lightning-formatted-url>
						&nbsp;to specify which records of that object should be deleted. Additionally, you can specify whether or
						not the records bypass the recycle bin, resulting in a permanent deletion. Finally, you can choose to
						activate or deactivate the task to specify whether or not it appears in the list of available tasks in the
						component.
					</p>
					<p class="slds-p-top_small slds-hyphenate">
						Power users can modify the <code>DemoCleanupCustomApex.runCustomApex</code> method, which is executed after
						all the records from the demo cleanup tasks are deleted. This could be useful for resetting demo parameters
						that do not involve deleting records, such as activating or deactivating users.
					</p>
					<h2 class="slds-p-top_large"><strong>Fail-Safe</strong></h2>
					<p class="slds-p-top_small slds-hyphenate">
						Several precautions are taken to ensure that only the records you want to delete are deleted.
					</p>
					<p class="slds-p-top_small slds-hyphenate">
						First, the component populates the <strong>Records</strong> column in the component by running a test query
						using the object API name and SOQL WHERE clause expression you supplied for each demo cleanup task. If any
						are in error, the component will display an error message and return 0 records for that task. You should
						also always check the record counts for each of the demo reset tasks to make sure that a suspiciously large
						number of records is not being deleted.
					</p>
					<p class="slds-p-top_small slds-hyphenate">
						Second, a modal dialog will pop up when you click the <strong>Cleanup the Demo</strong> button, confirming
						the actions that will be taken.
					</p>
					<h2 class="slds-p-top_large"><strong>Reference</strong></h2>
					<p class="slds-p-top_small slds-hyphenate">
						You can always find the latest version of this component in&nbsp;
						<lightning-formatted-url label="this GitHub repository" value="https://github.com/johnsfdemo/Demo-Cleanup">
						</lightning-formatted-url>
						.
					</p>
				</lightning-tile>
			</section>
		</template>
	</lightning-card>

	<template if:true={modalVisible}>
		<section
			role="dialog"
			tabindex="-1"
			class="slds-modal slds-fade-in-open slds-modal_small"
			aria-modal="true"
			aria-labelledby="modal-heading"
			aria-describedby="modal-content"
		>
			<div class="slds-modal__container">
				<header class="slds-modal__header slds-p-around_medium">
					<div class="slds-media slds-media_center">
						<div class="slds-media__figure slds-p-right_large">
							<lightning-icon icon-name="utility:warning" variant="warning" size="medium"> </lightning-icon>
						</div>
						<div class="slds-media__body">
							<p class="slds-text-align_center slds-text-heading_medium">
								<strong>Are You Sure?</strong>
							</p>
						</div>
					</div>
				</header>
				<div class="slds-modal__content">
					<p class="slds-p-around_large slds-hyphenate">
						You are about to delete&nbsp;
						<strong>
							<lightning-formatted-number value={totalRecords} class="slds-text-color_destructive">
							</lightning-formatted-number>
						</strong>
						&nbsp;record(s). &nbsp;
						<strong>
							<lightning-formatted-number value={totalRecycle} class="slds-text-color_destructive">
							</lightning-formatted-number>
						</strong>
						&nbsp;records will remain in the&nbsp;
						<lightning-formatted-url
							label="recycle bin"
							value="https://help.salesforce.com/articleView?id=recycle_bin.htm&amp;type=5"
						>
						</lightning-formatted-url>
						&nbsp;for up to 15 days, subject to the usual size limits of the bin. &nbsp;
						<strong>
							<lightning-formatted-number value={totalPermanent} class="slds-text-color_destructive">
							</lightning-formatted-number>
						</strong>
						&nbsp;records will be deleted permanently and will not be kept in the recycle bin.
					</p>
				</div>
				<footer class="slds-modal__footer">
					<lightning-button
						class="slds-p-right_medium"
						icon-name="utility:close"
						label="Cancel"
						variant="neutral"
						onclick={handleCancelButton}
					>
					</lightning-button>
					<lightning-button
						icon-name="utility:delete"
						label="Clean Up the Demo"
						variant="destructive"
						onclick={handleCleanupButton}
					>
					</lightning-button>
				</footer>
			</div>
		</section>
		<div class="slds-backdrop slds-backdrop_open"></div>
	</template>
</template>
